<!DOCTYPE html>
<html lang="en">
<head>
    <title>Property</title>
    <meta charset="UTF-8">
    <style>
        html, body {
            padding: 0px;
            margin: 0px;
        }

        .main {
            margin: 0px;
            padding: 0px;
            position: absolute;
            top: 0px;
            bottom: 0px;
            left: 0px;
            right: 0px;
            background-color: transparent !important;
        }

        .gray-bg {
            background-color: #d4d0cd;
        }

        #rootDiv {
            border-radius: 0 0 12px 12px;
            overflow-y: scroll; /* 垂直滚动条 */
            overflow-x: scroll; /* 水平滚动条，根据需要自动出现 */

        }

        .top-title-wrap {
            box-sizing: border-box;
            padding: 3px 4px;
            border-radius: 12px 12px 0 0;
            background-color: #c1c1c1
        }

        .top-title-inner {
            padding: 6px 6px 0;
            border-radius: 10px 10px 0 0;
            background-image: linear-gradient(to bottom, #e6e5e3, #d2d2d4, #ccc8c7);
            border-bottom: 1px solid #d6d2d0;
            font-size: 16px;
            line-height: 1.5;
            font-weight: 600
        }

        .custom-btns {
            box-sizing: border-box;
            height: 100%;
            padding: 0 4px;
            border: 1px solid #a2a2a2;
            background-image: linear-gradient(to bottom, #e6e5e3, #d2d2d4, #ccc8c7);
            display: flex;
            align-items: center;
        }

        .btn-in-wrap {
            flex-shrink: 0;
            display: block;
            position: relative;
            margin-left: 2px;
            margin-right: 2px;
            width: 32px;
            overflow: hidden;
            cursor: pointer;
        }

        .btn-in-wrap .custom-btn {
            margin-left: 0;
            margin-right: 0;
        }

        .btn-in-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
        }

        .custom-btn {
            flex-shrink: 0;
            display: block;
            margin-left: 2px;
            margin-right: 2px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            background: url(./images/icons.png) no-repeat center / 643px auto;
            background-position-y: -37px;
        }

        .custom-btn.selected, .custom-btn:hover, .btn-in-wrap:hover .custom-btn {
            background-position-y: 0;
        }

        .custom-btn.inactive {
            pointer-events: none;
            background-position-y: -75px !important;
        }

        .operate-right-wrap {
            display: flex;
            align-items: center;
            position: relative;
        }

        .operate-right-wrap:before {
            content: "";
            position: absolute;
            top: 2px;
            bottom: 2px;
            left: 5px;
            width: 5px;
            border-radius: 7px;
            background: linear-gradient(to right, #9b9b9b, #fafafa, #dfdfdf, #b9b9b9, #a2a2a2);
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
        }

        .operate-right-wrap label {
            width: 130px;
            text-align: right;
        }

        .operate-right-wrap .form-control {
            box-sizing: border-box;
            background: #FFFFFF none;
            border: 1px solid #7a7a7a;
            border-radius: 4px;
            color: inherit;
            display: block;
            padding: 3px 6px 4px;
            -webkit-transition: border-color 0.15s ease-in-out 0s, box-shadow 0.15s ease-in-out 0s;
            transition: border-color 0.15s ease-in-out 0s, box-shadow 0.15s ease-in-out 0s;
            width: 166px;
            height: 31px;
            font-size: 14px;
        }

        .operate-right-wrap .form-control:hover {
            border-color: #2a2c2f !important;
        }

        .operate-right-wrap .form-control:focus {
            border-color: #0078d7 !important;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 120, 215, 0.08), 0 0 2px rgba(0, 120, 215, 0.6) !important;
            box-shadow: inset 0 1px 1px rgba(0, 120, 215, 0.08), 0 0 2px rgba(0, 120, 215, 0.6) !important;
        }

        .property-wrap {
            background: #c1c1c1;
        }

        .property-wrap:before {
            z-index: 1;
            content: "";
            position: absolute;
            background: #d4d0cd;
            width: 100%;
            height: 10px;
            bottom: 0;
        }

        .property-wrap:after {
            z-index: 2;
            content: "";
            position: absolute;
            background: #c1c1c1;
            border-radius: 0 0 12px 12px !important;
            width: 100%;
            height: 10px;
            bottom: 0;
        }

        #clipboardTable {
            width: 100%;
            border-collapse: collapse;
        }

        #clipboardTable th {
            padding-top: 0;
            padding-bottom: 2px;
            line-height: 24px;
            border: 1px solid #bdbdbd;
            background-color: #f0f0f0;
            font-size: 18px;
            font-weight: 400;
        }

        #clipboardTable td {
            padding: 0 8px;
            border: 1px solid #bdbdbd;
            line-height: 28px;
            font-size: 16px;
        }

        #clipboardTable tbody tr.ui-selected {
            background-color: #3299ff;
            color: #fff;
        }
    </style>
    <link href="js/colorpicker/jquery.colorpicker.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="js/jquery-ui.css">
    <link rel="stylesheet" href="js/ContextMenu/custom-context-menu.css">

    <script src="js/ht/core/ht.js"></script>

    <script src="js/ht/plugin/ht-form.js"></script>
    <script src="js/ht/plugin/ht-propertypane.js"></script>
    <script src="js/FrameCommon.js"></script>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/jquery-ui.js"></script>
    <script src="js/jquery.thooClock.js"></script>
    <script src="js/ContextMenu/contextMenu.js"></script>
    <script src="js/ht/plugin/ht-cssanimation.js"></script>
    <script src="js/ht/plugin/ht-autolayout.js"></script>
    <script src="js/ht/plugin/ht-dialog.js"></script>

    <script src="js/debugTemp.js"></script>


    <script src="js/colorpicker/jquery.colorpicker.js"></script>

    <script src="js/colorpicker/i18n/jquery.ui.colorpicker-cn.js"></script>
    <script src="js/colorpicker/swatches/jquery.ui.colorpicker-pantone.js"></script>
    <script src="js/colorpicker/swatches/jquery.ui.colorpicker-crayola.js"></script>
    <script src="js/colorpicker/swatches/jquery.ui.colorpicker-ral-classic.js"></script>
    <script src="js/colorpicker/swatches/jquery.ui.colorpicker-x11.js"></script>
    <script src="js/colorpicker/swatches/jquery.ui.colorpicker-copic.js"></script>
    <script src="js/colorpicker/swatches/jquery.ui.colorpicker-prismacolor.js"></script>
    <script src="js/colorpicker/swatches/jquery.ui.colorpicker-isccnbs.js"></script>
    <script src="js/colorpicker/swatches/jquery.ui.colorpicker-din6164.js"></script>
    <script src="js/colorpicker/parts/jquery.ui.colorpicker-rgbslider.js"></script>
    <script src="js/colorpicker/parts/jquery.ui.colorpicker-memory.js"></script>
    <script src="js/colorpicker/parts/jquery.ui.colorpicker-swatchesswitcher.js"></script>
    <script src="js/colorpicker/parsers/jquery.ui.colorpicker-cmyk-parser.js"></script>
    <script src="js/colorpicker/parsers/jquery.ui.colorpicker-cmyk-percentage-parser.js"></script>

    <script type="module">
        import DrawXml from "./js/Element/XmlImport.js";
        import Nodes2xml from "./js/Element/XmlExport.js";
        import ClipboardCopyNewNode, {DrawClipboard} from "./js/Element/Clipboard.js";

        import {EmText} from "./js/Element/EmText.js";
        import {StTable} from "./js/Element/StTable.js";
        import {DtTable} from "./js/Element/DtTable.js";
        import {EmClock} from "./js/Element/EmClock.js";
        import {EmSubject} from "./js/Element/EmSubject.js";
        import {EmImage} from "./js/Element/EmImage.js";
        import {EmVideo} from "./js/Element/EmVideo.js";
        import {EmRectangle} from "./js/Element/EmRectangle.js";
        import {EmArrow} from "./js/Element/EmArrow.js";
        import {EmLine} from "./js/Element/EmLine.js";
        import {EmCircular} from "./js/Element/EmCircular.js";

        let selectNodeList = [];
        let tempColorBox;
        const backDivId = "divBack";
        window.dataModel = new ht.DataModel();
        //一定要使用这个参数，否则会缩放会出现异常
        //修改了JqueryUI中的缩放要使用这个参数计算鼠标移动修正
        window.scaleIncrement = 1;
        window.selectNode = null;
        let frameXmlParser = new DOMParser();

        const urlParams = new URLSearchParams(window.location.search);
        // 获取名为 'stationCode' 的参数
        StationCode = urlParams.get('stationCode');

        $(document).on('contextmenu', function(event) {
            event.preventDefault();
        });
        function ZoomOutIn(isBig, scale) {
            if (scale == null) {
                if (isBig) {
                    window.scaleIncrement += 0.1;
                } else {
                    window.scaleIncrement -= 0.1;
                }
                if (window.scaleIncrement <= 0.1) {
                    window.scaleIncrement = 0.1;
                }
            } else {
                window.scaleIncrement = scale;
            }

            backDiv.css('transform', 'scale(' + window.scaleIncrement + ')');
            backDiv.css('transform-origin', 'top left');
            $("#lblScale").text((window.scaleIncrement * 100).toFixed(0) + '%')

        }

        //控制按钮
        function InitControllerBar(showDiv) {

            let btnZoomOut = $('<button>').text('放大')
            btnZoomOut.click(function () {
                //transform-origin: top left; /* 定义变换的原点为左上角 */
                ZoomOutIn(true, null);
            });
            btnZoomOut.appendTo($(showDiv));

            let btnZoomIn = $('<button>').text('缩小')
            btnZoomIn.click(function () {
                ZoomOutIn(false, null);
            });
            btnZoomIn.appendTo($(showDiv));

            let btnZoomBack = $('<button>').text('复位')
            btnZoomBack.click(function () {
                ZoomOutIn(null, 1);
            });
            btnZoomBack.appendTo($(showDiv));
        }
        function hasGarbled(text) {
            // 匹配典型乱码符号（如 �）
            const garbledRegex = /�+/;

            // 匹配非预期字符（根据业务调整范围）
            const illegalCharRegex = /[^\x00-\x7F\u4E00-\u9FA5]/; // ASCII + 中文范围

            return garbledRegex.test(text) || illegalCharRegex.test(text);
        }

        //导入导出
        function InitButtonsBar(topLeftDiv) {
            let self = this;
            //加两个按钮
            //使用jquery 生成两个按钮
            let btnInOuter = $('<div>').addClass("btn-in-wrap").attr({"title": "导入"});
            let btnInSpan = createEleA("导入", "0");
            btnInSpan.attr("id", "btnImport");
            let btnInPut = $('<input type="file" style="display:none" />');
            btnInSpan.on('click', function() {
                btnInPut.click();
            });

            btnInPut.on('change', function(event) {
                let file = event.target.files[0];
                let file_reader = new FileReader();

                file_reader.onload = (e) => {
                    let buffer = e.target.result;
                    let decoder = new TextDecoder("UTF-8");
                    let fc = decoder.decode(new Uint8Array(buffer));
                    /*
                    let ret = hasGarbled(fc);
                    if (ret){
                        console.log("文件包含乱码,用GB2312重试");
                        decoder = new TextDecoder("GB2312");
                        fc = decoder.decode(new Uint8Array(buffer));
                    }
                     */
                    let backDiv = window.backDiv;

                    let xmlDoc = frameXmlParser.parseFromString(fc, "text/xml");
                    let xml = $(xmlDoc);
                    let typeStr = xml.find('Frame').find('ScreeTypeID').text();
                    let impName = xml.find('Frame').find('NAME').text();
                    if (impName === ''){
                        impName = xml.find('Frame').find('Name').text();
                    }
                    let impWidth = parseInt( xml.find('Frame').find('Width').text());
                    let impHeight = parseInt( xml.find('Frame').find('Height').text());
                    if (isNaN(impHeight)){
                        impHeight = parseInt( xml.find('Frame').find('Hight').text());
                    }
                    let typeObj = ParseScreenTypeStr(typeStr)
                    if (PisType > 0){
                        //检查分辨率
                        if (ScreenWidth !== impWidth || ScreenHeight !== impHeight){
                            let $alertMsg = $("#alertMsg");
                            $alertMsg.empty();
                            $alertMsg.html("导入的xml与当前屏幕分辨率不一致，请重新选择xml文件！");
                            let $alertDialog = $("#alertDialog");
                            $alertDialog.dialog({
                                autoOpen: false,
                                title: "提示",
                                zindex: AlertZIndex,
                                buttons: [
                                    {
                                        text: "确定",
                                        click: function () {
                                            $alertDialog.dialog("close");
                                        }
                                    }
                                ]
                            });
                            $alertDialog.dialog("open");
                            return;
                        }
                    }
                    ScreenWidth = typeObj.width;
                    ScreenHeight = typeObj.height;
                    SetNewBoard(ScreenWidth, ScreenHeight);
                    PisType = typeObj.screenType;
                    ScreenTypeDesc = typeObj.colorType;
                    DrawXml(backDiv, xml, dataModel);
                    //这里执行导入逻辑
                    importMode(impName)

                }
                file_reader.readAsArrayBuffer(file);
                event.target.value = '';
            });


            btnInSpan.appendTo(btnInOuter);

            btnInOuter.appendTo($(topLeftDiv));

            let btnOutPut = createEleA("导出", "-36px")
            btnOutPut.attr("id", "btnOutPut");
            btnOutPut.click(function () {
                let xml = Nodes2xml(dataModel);
                saveTextAsFile(xml, FrameName + ".xml");
            });
            btnOutPut.appendTo($(topLeftDiv));

            //其他按钮
            let btn1 = createEleA("添加元素", "-72px");
            btn1.attr("id", "btnAddEl");
            btn1.click(function () {
                OpenElementSelectDlg()
            });
            btn1.appendTo($(topLeftDiv));
            let btn2 = createEleA("清空元素", "-107px");
            btn2.attr("id", "btnCleanEl");
            btn2.click(function () {
                // CleanElement(ScreenWidth, ScreenHeight);
                // {obj: '415_1024*288;双彩', type: '2'}
                let str = PisType+"_"+ScreenWidth+"*"+ScreenHeight+";"+ScreenTypeDesc;
                window.reciveMsg({obj: str, type: '2'});

            });
            btn2.appendTo($(topLeftDiv));
            let btn3 = createEleA("复制元素", "-143px");
            btn3.attr("id", "btnCopyEl");
            btn3.click(function () {
                ClipboardCopyNewNode(window.selectNode);
            });
            btn3.appendTo($(topLeftDiv));
            let btn4 = createEleA("锁定元素", "-180px");
            btn4.attr("id", "btnLockEl");
            btn4.click(function () {
                SetLockStaSelected(true);
            });

            btn4.appendTo($(topLeftDiv));
            let btn5 = createEleA("解除锁定", "-216px");
            btn5.attr("id", "btnUnLockEl");
            btn5.click(function () {
                SetLockStaSelected(false);
            });

            btn5.appendTo($(topLeftDiv));
            let btn6 = createEleA("帧入库", "-252px");
            btn6.attr("id", "btnFrameSave");
            btn6.appendTo($(topLeftDiv));
            btn6.click(function () {
                AskAdd();
            });
            let btn7 = createEleA("删除帧", "-288px");
            btn7.appendTo($(topLeftDiv));
            btn7.attr("id", "btnFrameDel");
            btn7.click(function () {
                AskDel();
            });
            let btnPreview = createEleA("帧预览", "-324px");
            btnPreview.attr("id", "btnFramePrv");
            btnPreview.click(function () {
                let xml = Nodes2xml(dataModel);
                FramePreview(xml);
            });
            btnPreview.appendTo($(topLeftDiv));
            let btnAlignTop = createEleA("上对齐", "-360px");
            btnAlignTop.attr("id", "btnAlignTop")
            btnAlignTop.click(function () {
                AlignTop();
            });
            btnAlignTop.addClass("inactive");
            btnAlignTop.appendTo($(topLeftDiv));
            let btnAlignBottom = createEleA("下对齐", "-395px");
            btnAlignBottom.attr("id", "btnAlignBottom")
            btnAlignBottom.click(function () {
                AlignBottom();
            });
            btnAlignBottom.addClass("inactive");
            btnAlignBottom.appendTo($(topLeftDiv));
            let btnAlignLeft = createEleA("左对齐", "-431px");
            btnAlignLeft.attr("id", "btnAlignLeft")
            btnAlignLeft.click(function () {
                AlignLeft();
            });
            btnAlignLeft.addClass("inactive");
            btnAlignLeft.appendTo($(topLeftDiv));
            let btnAlignRight = createEleA("右对齐", "-468px");
            btnAlignRight.attr("id", "btnAlignRight")
            btnAlignRight.click(function () {
                AlignRight();
            });
            btnAlignRight.addClass("inactive");
            btnAlignRight.appendTo($(topLeftDiv));
            let btnHCAlign = createEleA("水平中心对齐", "-504px");
            btnHCAlign.attr("id", "btnHCAlign")
            btnHCAlign.click(function () {
                HorizontalCenterAlignment();
            });
            btnHCAlign.addClass("inactive");
            btnHCAlign.appendTo($(topLeftDiv));
            let btnVCAlign = createEleA("垂直中心对齐", "-539px");
            btnVCAlign.attr("id", "btnVCAlign")
            btnVCAlign.click(function () {
                VerticalCenterAlignment();
            });
            btnVCAlign.addClass("inactive");
            btnVCAlign.appendTo($(topLeftDiv));
            let btnHAvgAlign = createEleA("水平平均对齐", "-575px");
            btnHAvgAlign.attr("id", "btnHAvgAlign")
            btnHAvgAlign.click(function () {
                HorizontalAvgAlignment();
            });
            btnHAvgAlign.addClass("inactive");
            btnHAvgAlign.appendTo($(topLeftDiv));
            let btnVAvgAlign = createEleA("垂直平均对齐", "-611px");
            btnVAvgAlign.attr("id", "btnVAvgAlign")
            btnVAvgAlign.click(function () {
                VerticalAvgAlignment();
            });
            btnVAvgAlign.addClass("inactive");
            btnVAvgAlign.appendTo($(topLeftDiv));

            $('<div class="operate-right-wrap" ><label >显示比例：</label><label id="lblScale"  style="width: 50px">100%</label></div>').appendTo($(topLeftDiv));
        }

        window.setCtrDown = function (){
            ControlDown = true;
            $("#ctlShowSpan").text("  多选")
        }
        window.setCtrUp = function (){
            ControlDown = false;
            $("#ctlShowSpan").text("")
        }


        function init(width, height) {

            //根div，用户固定尺寸，绘制DOM
            $("#rootDiv").remove()
            let rootDiv = createDiv('rootDiv', '#c1c1c1');
            // $(rootDiv).css("box-sizing", "border-box");
            $(rootDiv).css("width", "100%");
            $(rootDiv).css("height", "88%");


            //这个是背板，放置根div
            let boardBackDiv = createDiv(backDivId, '#34495E00');
            let $backDiv = $(boardBackDiv);
            $backDiv.css("box-sizing", "border-box");
            $backDiv.css("background-image", "url('./images/back.png')");
            $backDiv.css("background-repeat", "repeat");
            window.backDiv = $backDiv;
            rootDiv.append(boardBackDiv);

            //左侧上DIV
            let topView = createDiv('leftTopArea', '#d4d0cd');
            let $topTitle = $('<div>').addClass("top-title-wrap");
            let $topTitleInner = $('<div>').addClass("top-title-inner").text('功能菜单');
            //创建一个span
            let $ctlShowSpan = $('<span>');
            $ctlShowSpan.attr("id", "ctlShowSpan");
            $ctlShowSpan.text(" ");
            $topTitleInner.append($ctlShowSpan)
            $topTitle.append($topTitleInner[0]);

            topView.append($topTitle[0]);
            let $operateArea = $('<div>').css({
                "box-sizing": "border-box",
                "height": "calc( 100% - 37px )",
                "padding": "0 3px",
                "background-color": "#c1c1c1"
            });
            let $operateAreaInner = $('<div>').addClass("custom-btns");
            InitButtonsBar($operateAreaInner);
            InitControllerBar($operateAreaInner);
            $operateArea.append($operateAreaInner[0]);
            topView.append($operateArea[0]);


            //这里是属性面板
            let propertyPane = new ht.widget.PropertyPane(dataModel); //属性面板

            let propertyView = propertyPane.getPropertyView();

            let rightPropertyView = propertyView.getView();
            rightPropertyView.className = 'property-wrap';
            //存入全局变量
            window.propertyView = propertyView;

            //右边有个tab分割
            let tabRightView = new ht.widget.TabView();
            tabRightView.setSelectBackground('#D26911');
            tabRightView.setTabBackground('#F5F5F5');
            tabRightView.setLabelColor('#333333');
            var propertyFrame = document.createElement('iframe');
            propertyFrame.id = "propertyFrame"
            // 设置iframe的属性
            propertyFrame.src = 'property.html'; // 指定URL
            propertyFrame.width = '100%'; // 宽度
            propertyFrame.height =  '100%'; // 高度
            propertyFrame.frameBorder = 0; // 边框
            window.propertyFrame = propertyFrame;

            AddTab(tabRightView, propertyFrame, '属性', true);
            let clipboard = createDiv('clipboard', '#BFBFBFFF');

            AddTab(tabRightView, clipboard, '粘贴板', false);
            window.clipboard = $(clipboard);
            DrawClipboard();
            //主视图，属性分割
            let topSplitView = new ht.widget.SplitView(topView, rootDiv, 'v', 80);
            topSplitView.setDividerSize(0);
            topSplitView.setDraggable(false);
            topSplitView.setDividerBackground('#d4d0cd');

            let mainView = new ht.widget.SplitView(topSplitView, tabRightView, 'h', -320);
            mainView.setDividerBackground('#d4d0cd');

            let view = mainView.getView();
            view.className = 'main';
            document.body.appendChild(view);
            window.addEventListener('resize', function (e) {
                mainView.invalidate();
            }, false);
            let backDivWidth = width;
            let backDivHeight = height;
            $backDiv.width(backDivWidth);
            $backDiv.height(backDivHeight);
            rootDiv.onLayouted = function (x, y, width, height) {
                // console.log(width,height,x,y);
                //计算y轴起始位置
                let sTop = $(window).height() - height;
                //如果x轴不是从0开始，可能还需要计算x轴起始位置
                //将backDiv 放置在中心位置
                let backDivLeft = 10;//width/2 - backDivWidth/2;
                if (backDivLeft < 0)
                    backDivLeft = 0;
                let backDivTop = 10;//height/2 - backDivHeight/2;
                if (backDivTop < 0)
                    backDivTop = 0;
                $backDiv.offset({left: backDivLeft, top: backDivTop + sTop});
                // console.log(backDivLeft,backDivTop);
            };
            $(rootDiv).on('mousedown', function (e) {

                //鼠标点击背板
                if (e.target instanceof HTMLDivElement) {
                    let selDiv = $(e.target)
                    if (selDiv.attr("id") === $(rootDiv).attr("id")) {

                        //window.backDiv.find('div[id^="sel_"]').remove();
                        CleanAllSelection();
                        SetSelectButtonVisible();
                        console.log("清空选择控件");
                    }
                }

            });
            $backDiv.on('mousedown', function (e) {

                //鼠标点击背板
                if (e.target instanceof HTMLDivElement) {
                    let selDiv = $(e.target)
                    if (selDiv.attr("id") === window.backDiv.attr("id")) {
                        CleanAllSelection();
                        SetSelectButtonVisible();
                        console.log("清空选择控件");
                    }
                }

            });

            window.addEventListener("keydown", function (e) {
                if (e.key === "Control") {
                    window.setCtrDown();
                }
                if (window.selectNode !== null) {


                }


            });
            window.addEventListener("keyup", function (e) {
                if (e.key === "Control") {
                    window.setCtrUp();
                }

            });


        }

        function createEleA(text, posX) {
            posX = posX ? posX : 0;
            return $('<a>').attr({"title": text}).addClass("custom-btn").css("background-position-x", posX);
        }
        function CleanElement(width, height){
            //清理node
            let elFrame = window.propertyFrame;
            elFrame.contentWindow.ClearProperty();
            let allData = window.dataModel.getDatas();
            for (let i = 0; i < allData._as.length; i++) {
                window.dataModel.remove(allData[i]);
            }
            window.dataModel.clear();
            window.dataModel.clear();
            //一定要使用这个参数，否则会缩放会出现异常
            //修改了JqueryUI中的缩放要使用这个参数计算鼠标移动修正
            window.scaleIncrement = 1;
            window.selectNode = null;
            backDiv.css('transform', 'scale(' + window.scaleIncrement + ')');
            backDiv.css('transform-origin', 'top left');
            //背板调整
            let $rootDiv = $("#rootDiv");
            $rootDiv.width("100%");
            $rootDiv.height("88%");

            //清空属性
            window.propertyView.setProperties(null);

            window.backDiv.empty();
            backDiv.width(width);
            backDiv.height(height);
        }

        function SetNewBoard(width, height) {
            //清理node
            let elFrame = window.propertyFrame;
            elFrame.contentWindow.ClearProperty();

            let allData = window.dataModel.getDatas();
            for (let i = 0; i < allData._as.length; i++) {
                window.dataModel.remove(allData[i]);
            }
            window.dataModel.clear();
            //一定要使用这个参数，否则会缩放会出现异常
            //修改了JqueryUI中的缩放要使用这个参数计算鼠标移动修正
            window.scaleIncrement = 1;
            window.selectNode = null;
            FrameId = "";
            FrameName = "";
            PisType = -1;
            backDiv.css('transform', 'scale(' + window.scaleIncrement + ')');
            backDiv.css('transform-origin', 'top left');
            //背板调整
            let $rootDiv = $("#rootDiv");
            $rootDiv.width("100%");
            $rootDiv.height("88%");

            //清空属性
            window.propertyView.setProperties(null);

            window.backDiv.empty();
            backDiv.width(width);
            backDiv.height(height);
        }


        function lockTool(){
            $('#btnImport').addClass("inactive");
            $('#btnOutPut').addClass("inactive");
            $('#btnAddEl').addClass("inactive");
            $('#btnCleanEl').addClass("inactive");
            $('#btnCopyEl').addClass("inactive");
            $('#btnLockEl').addClass("inactive");
            $('#btnUnLockEl').addClass("inactive");
            $('#btnFrameSave').addClass("inactive");
            $('#btnFrameDel').addClass("inactive");
            $('#btnFramePrv').addClass("inactive");
        }
        function unlockTool(){
            $('#btnImport').removeClass("inactive");
            $('#btnOutPut').removeClass("inactive");
            $('#btnAddEl').removeClass("inactive");
            $('#btnCleanEl').removeClass("inactive");
            $('#btnCopyEl').removeClass("inactive");
            $('#btnLockEl').removeClass("inactive");
            $('#btnUnLockEl').removeClass("inactive");
            $('#btnFrameSave').removeClass("inactive");
            $('#btnFrameDel').removeClass("inactive");
            $('#btnFramePrv').removeClass("inactive");
        }

        window.onload = function () {

            init(500, 500);
            window.reciveMsg = function (obj) {
                //415_1152*640;全彩
                let typeStr = "";
                if (obj.type === "-1"){
                    console.log(obj);
                    //todo:锁定工具栏显示
                    lockTool();
                }else if (obj.type === "0") {
                    let dsObj = obj.obj;
                    DsInfo = dsObj;
                    console.log(dsObj);
                } else if (obj.type === "2") {
                    unlockTool();
                    //屏幕尺寸。类型
                    typeStr = obj.obj;
                    let typeObj = ParseScreenTypeStr(typeStr)
                    if (isNaN( typeObj.screenType)){
                        return;
                    }
                    ScreenWidth = typeObj.width;
                    ScreenHeight = typeObj.height;
                    SetNewBoard(ScreenWidth, ScreenHeight);
                    PisType = typeObj.screenType;
                    ScreenTypeDesc = typeObj.colorType;
                    console.log(obj);
                } else if (obj.type === "1") {
                    unlockTool();
                    //帧数据
                    StationCode = obj.stationCode;

                    let frameInfo = obj.obj;
                    if (frameInfo === undefined) {
                        console.log("帧字符串为空");
                    } else {
                        let xmlDoc = frameXmlParser.parseFromString(frameInfo, "text/xml");
                        let xml = $(xmlDoc);
                        typeStr = xml.find('ScreeTypeID').text();
                        let typeObj = ParseScreenTypeStr(typeStr)
                        ScreenWidth = typeObj.width;
                        ScreenHeight = typeObj.height;
                        ScreenTypeDesc = typeObj.colorType;
                        SetNewBoard(ScreenWidth, ScreenHeight);
                        FrameName = xml.find('NAME').text();
                        FrameId = obj.modId;
                        PisType = typeObj.screenType;
                        DrawXml(window.backDiv, xml, dataModel);
                        console.log(obj);
                    }
                }
            }
            window.openColorPicker = function ($textBox) {
                $('#colorPickerInput').val($textBox.val())
                tempColorBox = $textBox;
                $("#dialogColorPick").dialog("open");
            }

        }

        function postMessageToParent(arg) {
            window.parent.postMessage(arg, "*");
        }


        function saveTextAsFile(text, filename) {
            // 创建一个Blob实例，类型为纯文本
            var blob = new Blob([text], {type: 'text/plain'});

            // 创建一个指向Blob对象的URL
            var url = URL.createObjectURL(blob);

            // 创建一个a标签
            var a = document.createElement("a");

            // 设置a标签属性
            a.href = url;
            a.download = filename;

            // 模拟a标签点击，触发下载
            document.body.appendChild(a);
            a.click();

            // 清理临时DOM和对象URL
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        //打开元素选择对话框
        function OpenElementSelectDlg() {
            let $dlgDiv = $('<div>', {id: 'elementSelectDialog',});
            let $table = $('<table></table>'); // 创建一个表格元素

            //时钟
            let $tr = $('<tr></tr>'); // 创建一行
            let $btnAddClock = $('<button>').text('时钟')
            $btnAddClock.click(function () {
                //todo: 添加时钟
                let node = EmClock.CreateNode(null, FindMaxIndex() + 5)
                let em = new EmClock(backDiv, node);
                $dlgDiv.dialog("close");
                $dlgDiv.dialog("destroy").remove();
                em.CreateEm();
            });
            let $td = $('<td></td>'); // 创建一个单元格
            $td.append($btnAddClock); // 设置单元格内容
            $tr.append($td); // 将单元格添加到行中
            $table.append($tr);

            $tr = $('<tr></tr>'); // 创建一行
            let $btnAddStTable = $('<button>').text('静态表格')
            $btnAddStTable.click(function () {
                //添加表格
                let node = StTable.CreateNode(null, FindMaxIndex() + 5)
                let em = new StTable(backDiv, node);
                $dlgDiv.dialog("close");
                $dlgDiv.dialog("destroy").remove();
                em.CreateEm();
            });
            $td = $('<td></td>'); // 创建一个单元格
            $td.append($btnAddStTable); // 设置单元格内容
            $tr.append($td); // 将单元格添加到行中
            $table.append($tr);

            $tr = $('<tr></tr>'); // 创建一行
            let $btnAddDtTable = $('<button>').text('数据表格')
            $btnAddDtTable.click(function () {
                //添加表格
                let node = DtTable.CreateNode(null, FindMaxIndex() + 5)
                let em = new DtTable(backDiv, node);
                $dlgDiv.dialog("close");
                $dlgDiv.dialog("destroy").remove();
                em.CreateEm();
            });
            $td = $('<td></td>'); // 创建一个单元格
            $td.append($btnAddDtTable); // 设置单元格内容
            $tr.append($td); // 将单元格添加到行中
            $table.append($tr);


            //文本
            $tr = $('<tr></tr>'); // 创建一行
            let $btnAddText = $('<button>').text('文本')
            $btnAddText.click(function () {
                //添加文本
                let node = EmText.CreateNode(null, FindMaxIndex() + 5)
                let em = new EmText(backDiv, node);
                $dlgDiv.dialog("close");
                $dlgDiv.dialog("destroy").remove();
                em.CreateEm();
            });
            $td = $('<td></td>'); // 创建一个单元格
            $td.append($btnAddText); // 设置单元格内容
            $tr.append($td); // 将单元格添加到行中
            $table.append($tr);

            //专题
            $tr = $('<tr></tr>'); // 创建一行
            let $btnAddSubject = $('<button>').text('专题')
            $btnAddSubject.click(function () {
                //添加专题
                let node = EmSubject.CreateNode(null, FindMaxIndex() + 5)
                let em = new EmSubject(backDiv, node);
                $dlgDiv.dialog("close");
                $dlgDiv.dialog("destroy").remove();
                em.CreateEm();

            });
            $td = $('<td></td>'); // 创建一个单元格
            $td.append($btnAddSubject); // 设置单元格内容
            $tr.append($td); // 将单元格添加到行中
            $table.append($tr);

            $tr = $('<tr></tr>'); // 创建一行
            let $btnAddPic = $('<button>').text('图片')
            $btnAddPic.click(function () {
                //添加图片
                let node = EmImage.CreateNode(null, FindMaxIndex() + 5)
                let em = new EmImage(backDiv, node);
                $dlgDiv.dialog("close");
                $dlgDiv.dialog("destroy").remove();
                em.CreateEm();

            });
            $td = $('<td></td>'); // 创建一个单元格
            $td.append($btnAddPic); // 设置单元格内容
            $tr.append($td); // 将单元格添加到行中
            $table.append($tr);

            //视频
            $tr = $('<tr></tr>'); // 创建一行
            let $btnAddVideo = $('<button>').text('视频')
            $btnAddVideo.click(function () {
                //添加视频
                let node = EmVideo.CreateNode(null, FindMaxIndex() + 5)
                let em = new EmVideo(backDiv, node);
                $dlgDiv.dialog("close");
                $dlgDiv.dialog("destroy").remove();
                em.CreateEm();

            });
            $td = $('<td></td>'); // 创建一个单元格
            $td.append($btnAddVideo); // 设置单元格内容
            $tr.append($td); // 将单元格添加到行中
            $table.append($tr);


            $tr = $('<tr></tr>'); // 创建一行
            let $btnAddRect = $('<button>').text('矩形')
            $btnAddRect.click(function () {
                let node = EmRectangle.CreateNode(null, FindMaxIndex() + 5)
                let em = new EmRectangle(backDiv, node);
                $dlgDiv.dialog("close");
                $dlgDiv.dialog("destroy").remove();
                em.CreateEm();
            });
            $td = $('<td></td>'); // 创建一个单元格
            $td.append($btnAddRect); // 设置单元格内容
            $tr.append($td); // 将单元格添加到行中
            $table.append($tr);

            $tr = $('<tr></tr>'); // 创建一行
            let $btnAddEllipse = $('<button>').text('椭圆')
            $btnAddEllipse.click(function () {
                //todo: 添加椭圆
                let node = EmCircular.CreateNode(null, FindMaxIndex() + 5)
                let em = new EmCircular(backDiv, node);
                $dlgDiv.dialog("close");
                $dlgDiv.dialog("destroy").remove();
                em.CreateEm();


            });
            $td = $('<td></td>'); // 创建一个单元格
            $td.append($btnAddEllipse); // 设置单元格内容
            $tr.append($td); // 将单元格添加到行中
            $table.append($tr);

            $tr = $('<tr></tr>'); // 创建一行
            let $btnAddLine = $('<button>').text('直线')
            $btnAddLine.click(function () {
                //添加直线
                let node = EmLine.CreateNode(null, FindMaxIndex() + 5)
                let em = new EmLine(backDiv, node);
                $dlgDiv.dialog("close");
                $dlgDiv.dialog("destroy").remove();
                em.CreateEm();

            });
            $td = $('<td></td>'); // 创建一个单元格
            $td.append($btnAddLine); // 设置单元格内容
            $tr.append($td); // 将单元格添加到行中
            $table.append($tr);

            $tr = $('<tr></tr>'); // 创建一行
            let $btnAddArrow = $('<button>').text('箭头线')
            $btnAddArrow.click(function () {

                //EmArrow
                let node = EmArrow.CreateNode(null, FindMaxIndex() + 5)
                let em = new EmArrow(backDiv, node);
                $dlgDiv.dialog("close");
                $dlgDiv.dialog("destroy").remove();
                em.CreateEm();

            });
            $td = $('<td></td>'); // 创建一个单元格
            $td.append($btnAddArrow); // 设置单元格内容
            $tr.append($td); // 将单元格添加到行中
            $table.append($tr);

            // 设置表格宽度和高度为100%
            $table.css({
                'width': '100%',
                'height': '100%',
                'border': '0px solid #ccc',
                'border-collapse': 'collapse'
            });

            $table.find('th, td').css({
                "background-color": "rgba(52,51,51,0)",
                'width': '100%',
                'height': '20px'

            });
            $table.find('button').css({
                'width': '100%',
                'height': '100%'
            });
            $dlgDiv.get(0).appendChild($table.get(0));
            $dlgDiv.dialog({
                zIndex: AlertZIndex,
                autoOpen: true,
                title: "请选择模块",
                width: 200,
                height: 400,
                modal: true,
                buttons: []
            });


        }


        function AskAdd() {
            if (FrameId !== null && FrameId !== "") {
                let $alertMsg = $("#alertMsg");
                $alertMsg.empty();
                $alertMsg.html("更新还是新增模板？");
                let $alertDialog = $("#alertDialog");
                $alertDialog.dialog({
                    autoOpen: false,
                    title: "提示",
                    zindex: AlertZIndex,
                    buttons: [
                        {
                            text: "更新",
                            click: function () {
                                $alertDialog.dialog("close");
                                AskSave();
                            }
                        },
                        {
                            text: "新增",
                            click: function () {
                                FrameId = "";
                                $alertDialog.dialog("close");
                                AskSave();
                            }
                        }
                    ]
                });
                $alertDialog.dialog("open");

            } else {
                AskSave();
            }
        }

        function AskSave() {
            //检查数据源是否填入
            let checkDs = CheckDataSource();
            if (!checkDs){
                return;
            }
            
            if (FrameId === "" || FrameId === null) {

                let $alertContent =  $("#alertMsg");
                $alertContent.empty();
                let $msg = $('<span/>');
                $msg.html("请输入模板名称");
                $alertContent.append($msg)
                let $input = $('<input/>');
                $input.attr("type", "text");
                $input.attr("id", "txtModeNewName");
                $alertContent.append($input)
                let $alertDialog = $("#alertDialog");
                $alertDialog.dialog({
                    autoOpen: false,
                    title: "提示",
                    zindex: AlertZIndex,
                    buttons: [
                        {
                            text: "确定",
                            click: function () {
                                let modName =  $input.val();
                                FrameName = modName;
                                InsertOrUpdateFrame(modName, null);
                                $alertDialog.dialog("close");

                            }
                        },
                        {
                            text: "取消",
                            click: function () {
                                $alertDialog.dialog("close");
                            }
                        }
                    ]
                });
                $alertDialog.dialog("open");


            } else {
                InsertOrUpdateFrame(null, FrameId);
            }
        }
        function CheckDataSource() {
            let nodes = dataModel.getDatas();
            for (let i = 0; i < nodes._as.length; i++) {
                var node = nodes.get(i);
                let dsStr = node.a("DATASET");
                if (dsStr === undefined)
                {
                    continue;
                }else{
                    if( dsStr === ''){
                        let name = node.a("name");
                        var index = node.a("index");
                        //使用模态提示，数据源没有输入
                        let  $alertMsg = $("#alertMsg");
                        $alertMsg.empty();
                        $alertMsg.html("序列为" + index + ",名称为“"+  name + "”的元素没有选择数据源");
                        let $alertDialog = $("#alertDialog");
                        $alertDialog.dialog({
                            autoOpen: false,
                            title: "提示",
                            zindex: AlertZIndex,
                            buttons: [
                                {
                                    text:  "确定",
                                    click: function () {
                                        $alertDialog.dialog("close");
                                    }
                                }

                            ]
                        });
                        $alertDialog.dialog("open");
                        return false;
                    }
                }
            }
            return true;
        }
        function InsertOrUpdateFrame(newName, modId) {
            let message = Nodes2xml(dataModel);

            if (newName !== null && newName !== "") {
                //对newName 进行url编码
                newName = encodeURIComponent(newName);
            } else if (modId !== null && modId !== "") {
                modId = encodeURIComponent(modId);
            }
            //&expandStationCode=${StationCode}
            let url = `/imp/pis/modeditor/add?stationCode=${StationCode}&modId=${modId}&newName=${newName}&expandStationCode=${StationCode}`
            $.ajax({
                url: url,
                type: "post",
                data: message,
                contentType: "application/xml",
                success: function (result) {
                    let title = '提示';
                    if (result.code.toString() !== "0") {
                        title = "异常！";
                    }
                    let  $alertMsg = $("#alertMsg");
                    $alertMsg.empty();
                    $alertMsg.html(result.msg);
                    let $alertDialog = $("#alertDialog");
                    $alertDialog.dialog({
                        autoOpen: false,
                        title: title,
                        zindex: AlertZIndex,
                        buttons: [
                            {
                                text: "确定",
                                click: function () {
                                    postMessageToParent({type:3,data:"NeedRefList"});
                                    $alertDialog.dialog("close");
                                }
                            }

                        ]
                    });
                    $alertDialog.dialog("open");
                    postMessageToParent({type:3,data:"NeedRefList"});
                },
                error: function (errorMsg) {
                    let  $alertMsg = $("#alertMsg");
                    $alertMsg.empty();
                    $alertMsg.html(errorMsg);
                    let $alertDialog = $("#alertDialog");
                    $alertDialog.dialog({
                        autoOpen: false,
                        title: "异常",
                        zindex: AlertZIndex,
                        buttons: [
                            {
                                text: "确定",
                                click: function () {
                                    $alertDialog.dialog("close");
                                }
                            }

                        ]
                    });
                    $alertDialog.dialog("open");

                }
            });
        }

        function importMode(newName){
            let message = Nodes2xml(dataModel);
            let url = `/imp/pis/modeditor/importMod?stationCode=${StationCode}&newName=${newName}&expandStationCode=${StationCode}`
            $.ajax({
                url: url,
                type: "post",
                data: message,
                contentType: "application/xml",
                success: function (result) {
                    let title = '提示';
                    if (result.code.toString() !== "0") {
                        title = "异常！";
                    }
                    let  $alertMsg = $("#alertMsg");
                    $alertMsg.empty();
                    $alertMsg.html(result.msg);
                    let $alertDialog = $("#alertDialog");
                    $alertDialog.dialog({
                        autoOpen: false,
                        title: title,
                        zindex: AlertZIndex,
                        buttons: [
                            {
                                text: "确定",
                                click: function () {
                                    postMessageToParent({type:3,data:"NeedRefList"});
                                    $alertDialog.dialog("close");
                                }
                            }

                        ]
                    });
                    $alertDialog.dialog("open");
                    postMessageToParent({type:3,data:"NeedRefList"});
                },
                error: function (errorMsg) {
                    let  $alertMsg = $("#alertMsg");
                    $alertMsg.empty();
                    $alertMsg.html(errorMsg);
                    let $alertDialog = $("#alertDialog");
                    $alertDialog.dialog({
                        autoOpen: false,
                        title: "异常",
                        zindex: AlertZIndex,
                        buttons: [
                            {
                                text: "确定",
                                click: function () {
                                    $alertDialog.dialog("close");
                                }
                            }

                        ]
                    });
                    $alertDialog.dialog("open");

                }
            });
        }

        function AskDel() {
            if (FrameId === "") {
                return;
            }
            let  $alertMsg = $("#alertMsg");
            $alertMsg.empty();
            $alertMsg.html("确定要删除帧“" + FrameName + "”吗？");
            let $alertDialog = $("#alertDialog");
            $alertDialog.dialog({
                autoOpen: false,
                title: "提示",
                zindex: AlertZIndex,
                buttons: [
                    {
                        text: "确定",
                        click: function () {
                            $alertDialog.dialog("close");
                            DeleteFrame(FrameId);
                        }
                    },
                    {
                        text: "取消",
                        click: function () {
                            $alertDialog.dialog("close");
                        }
                    }

                ]
            });
            $alertDialog.dialog("open");

        }

        function DeleteFrame(modId) {
            let url = "/imp/pis/modeditor/remove?stationCode=" + StationCode
                + "&modId=" + modId + "&expandStationCode" + StationCode;
            $.ajax({
                url: url,
                type: "post",
                success: function (result) {

                    let title = '提示';
                    if (result.code.toString() !== "0") {
                        title = "异常！";
                    }
                    let  $alertMsg = $("#alertMsg");
                    $alertMsg.empty();
                    $alertMsg.html(result.msg);
                    let $alertDialog = $("#alertDialog");
                    $alertDialog.dialog({
                        autoOpen: false,
                        title: title,
                        zindex: AlertZIndex,
                        buttons: [
                            {
                                text: "确定",
                                click: function () {
                                    postMessageToParent({type:3,data:"NeedRefList"});
                                    $alertDialog.dialog("close");
                                }
                            }

                        ]
                    });
                    $alertDialog.dialog("open");


                },
                error: function (errorMsg) {
                    let $alertMsg = $("#alertMsg");
                    $alertMsg.empty();
                    $alertMsg.html(errorMsg);
                    let $alertDialog = $("#alertDialog");
                    $alertDialog.dialog({
                        autoOpen: false,
                        title: "异常",
                        zindex: AlertZIndex,
                        buttons: [
                            {
                                text: "确定",
                                click: function () {
                                    $alertDialog.dialog("close");
                                }
                            }

                        ]
                    });
                    $alertDialog.dialog("open");
                }
            });
        }


        function TestGet(data) {
            //      if(data.type==1)
            {


                $.ajax({
                    url: "http://localhost:8888/imp/pis/modeditor/xml?stationCode=GZGZN&id=" + "1ff6a1f062e84b1f8c55769a54885482",
                    type: "get",
                    success: function (result) {
                        $.modal.msgSuccess(result.msg);
                        $("#bootstrap-table").bootstrapTable('refresh');
                    },
                    error: function (errorMsg) {
                        $.modal.msgWarning(errorMsg);
                    }
                });

            }
        }

        $(document).ready(function() {
            $("#dialogColorPick").dialog({
                zIndex: AlertZIndex,
                title: "颜色弹出框",
                width: 600,
                height: 500,
                modal: true,
                buttons: [],
                autoOpen: false, // 设置为false，所以它不会自动打开
                closeOnEscape: false, // 禁用ESC键关闭
                open: function(event, ui) {
                    // 移除对话框右上角的关闭按钮
                    $(this).parent().find('.ui-dialog-titlebar-close').hide();
                }
        
            });

            $('#colorPickerInput').colorpicker({
                alpha: true,
                modal:true,
                showCloseButton: false,
                parts:  ['header', 'map', 'bar', 'hsv', 'rgb', 'alpha', 'preview', 'swatches', 'footer'],
                regional: 'cn',
                colorFormat: 'HEXA',
                // select: function(event, color) {
                //     $('#colorPickerInput').text(color.formatted);
                // },
                ok: function(event, color) {
                    let $dlg = $("#dialogColorPick");
                    // let rgbaArr = color.formatted.split("(")[1].split(")")[0].split(",");
                    // let hexStr = rgbaToHex(rgbaArr[0], rgbaArr[1], rgbaArr[2], rgbaArr[3]);
                    let hexStr ="#"+color.formatted;
                    $('#colorPickerInput').val(hexStr);
                    tempColorBox.val(hexStr);
                    tempColorBox.css("background-color", hexStr);
                    tempColorBox.setColor(hexStr);
                    $dlg.dialog("close");

                    console.log(color.formatted);
                },
                cancel: function(event, color) {
                    let $dlg = $("#dialogColorPick");
                    $dlg.dialog("close");
                }


                // 其他配置，比如显示模式、位置等

            });

        });
    </script>
    <script src="js/ht/plugin/ht-dialog.js"></script>
</head>
<body class="gray-bg">
<div id="dialog" title="基本的对话框">

</div>

<div id="dialogColorPick" title="颜色选择" style="display: none;">
    <input type="text" id="colorPickerInput" value="#ff0000">
</div>
<div id="alertDialog" title="提示" style="display: none;">
    <span id = "alertMsg"></span>
</div>
</body>
</html>
